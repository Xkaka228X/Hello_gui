--[[ 
    RGB ULTIMATE V40 (HITBOX RESET FIX + FULL STABLE)
]]

local lplr = game.Players.LocalPlayer
local camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")

local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "ULTIMATE_V40"
ScreenGui.ResetOnSpawn = false

-- Состояния
local ws, jp, aim, fovOn, hit, esp, espInf, trac, noclip, light = 16, 50, false, false, false, false, false, false, false, false
local rgb = Color3.new(1,1,1)

-- RGB Цикл
task.spawn(function()
    while true do
        for i = 0, 1, 0.005 do
            rgb = Color3.fromHSV(i, 0.8, 1)
            task.wait()
        end
    end
end)

local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 2; fovCircle.NumSides = 64; fovCircle.Radius = 150; fovCircle.Visible = false

-- МЕНЮ
local Main = Instance.new("Frame", ScreenGui)
Main.BackgroundColor3 = Color3.fromRGB(15, 15, 15); Main.Position = UDim2.new(0.5, -180, 0.3, 0)
Main.Size = UDim2.new(0, 360, 0, 210); Main.Active = true; Main.Visible = true
Instance.new("UICorner", Main); local mStr = Instance.new("UIStroke", Main); mStr.Thickness = 2

local hBtn = Instance.new("TextButton", ScreenGui)
hBtn.Size = UDim2.new(0, 35, 0, 35); hBtn.Position = UDim2.new(0, 10, 0, 10)
hBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20); hBtn.Text = "H"; hBtn.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", hBtn); local hStr = Instance.new("UIStroke", hBtn); hStr.Thickness = 2

local Grid = Instance.new("UIGridLayout", Main)
Grid.CellSize = UDim2.new(0, 85, 0, 35); Grid.CellPadding = UDim2.new(0, 3, 0, 5)
Grid.HorizontalAlignment = "Center"; Grid.VerticalAlignment = "Center"

local function createBtn(t)
    local b = Instance.new("TextButton", Main)
    b.BackgroundColor3 = Color3.fromRGB(30, 30, 30); b.TextColor3 = Color3.new(1,1,1)
    b.Text = t; b.Font = "SourceSansBold"; b.TextSize = 11; Instance.new("UICorner", b)
    return b
end

local sBtn = createBtn("- SPD: 16 +"); local jBtn = createBtn("- JMP: 50 +")
local aBtn = createBtn("AIM: OFF"); local fBtn = createBtn("FOV: OFF")
local hiBtn = createBtn("HIT: OFF"); local eBtn = createBtn("ESP: OFF")
local eiBtn = createBtn("INFO: OFF"); local tBtn = createBtn("LINE: OFF")
local nBtn = createBtn("NOCLIP: OFF"); local lBtn = createBtn("LIGHT: OFF")
local iBtn = createBtn("INVIZ"); local adiBtn = createBtn("ADIDAS"); local emoBtn = createBtn("EMOTE")

task.spawn(function()
    while true do
        hStr.Color = rgb; mStr.Color = rgb; fovCircle.Color = rgb
        iBtn.TextColor3 = rgb; adiBtn.TextColor3 = rgb; emoBtn.TextColor3 = rgb; task.wait()
    end
end)

-- Управление SPD/JMP
sBtn.MouseButton1Click:Connect(function() 
    local mX = UserInputService:GetMouseLocation().X
    ws = (mX < (sBtn.AbsolutePosition.X + sBtn.AbsoluteSize.X/2)) and math.max(16, ws - 10) or ws + 10
    sBtn.Text = "- SPD: "..ws.." +"
end)
jBtn.MouseButton1Click:Connect(function() 
    local mX = UserInputService:GetMouseLocation().X
    jp = (mX < (jBtn.AbsolutePosition.X + jBtn.AbsoluteSize.X/2)) and math.max(0, jp - 10) or jp + 10
    jBtn.Text = "- JMP: "..jp.." +"
end)

-- Переключатели
hBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)
aBtn.MouseButton1Click:Connect(function() aim = not aim; aBtn.Text = "AIM: "..(aim and "ON" or "OFF") end)
fBtn.MouseButton1Click:Connect(function() fovOn = not fovOn; fBtn.Text = "FOV: "..(fovOn and "ON" or "OFF") end)
eBtn.MouseButton1Click:Connect(function() esp = not esp; eBtn.Text = "ESP: "..(esp and "ON" or "OFF") end)
eiBtn.MouseButton1Click:Connect(function() espInf = not espInf; eiBtn.Text = "INFO: "..(espInf and "ON" or "OFF") end)
tBtn.MouseButton1Click:Connect(function() trac = not trac; tBtn.Text = "LINE: "..(trac and "ON" or "OFF") end)

hiBtn.MouseButton1Click:Connect(function() 
    hit = not hit; hiBtn.Text = "HIT: "..(hit and "ON" or "OFF")
    if not hit then -- СБРОС ХИТБОКСОВ
        for _, p in pairs(game.Players:GetPlayers()) do
            if p ~= lplr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                p.Character.HumanoidRootPart.Size = Vector3.new(2, 2, 1)
                p.Character.HumanoidRootPart.Transparency = 1
            end
        end
    end
end)

nBtn.MouseButton1Click:Connect(function() noclip = not noclip; nBtn.Text = "NOCLIP: "..(noclip and "ON" or "OFF") end)
lBtn.MouseButton1Click:Connect(function() 
    light = not light; lBtn.Text = "LIGHT: "..(light and "ON" or "OFF")
    if not light then Lighting.Brightness = 1; Lighting.ClockTime = 12; Lighting.GlobalShadows = true end
end)

-- Скрипты
iBtn.MouseButton1Click:Connect(function() loadstring(game:HttpGet('https://pastebin.com/raw/3Rnd9rHf'))() end)
adiBtn.MouseButton1Click:Connect(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Anzzckc/Pack-Animation-01/refs/heads/main/PackAdidasAnimation%20.lua"))() end)
emoBtn.MouseButton1Click:Connect(function() loadstring(game:HttpGet("https://rawscripts.net/raw/Universal-Script-7yd7-I-Emote-Script-48024"))() end)

-- ЛОГИКА NOCLIP
RunService.Stepped:Connect(function()
    if lplr.Character then
        for _, v in pairs(lplr.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = not noclip
            end
        end
    end
end)

-- ГЛАВНЫЙ ЦИКЛ ОБНОВЛЕНИЯ
RunService.RenderStepped:Connect(function()
    if lplr.Character and lplr.Character:FindFirstChild("Humanoid") then
        lplr.Character.Humanoid.WalkSpeed = ws
        lplr.Character.Humanoid.JumpPower = jp
    end
    
    if light then Lighting.Brightness = 2; Lighting.ClockTime = 14; Lighting.GlobalShadows = false end

    -- Hitbox Logic
    if hit then
        for _, p in pairs(game.Players:GetPlayers()) do
            if p ~= lplr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                p.Character.HumanoidRootPart.Size = Vector3.new(15, 15, 15)
                p.Character.HumanoidRootPart.Transparency = 0.7
                p.Character.HumanoidRootPart.Color = rgb
                p.Character.HumanoidRootPart.CanCollide = false
            end
        end
    end

    -- AIM & FOV (Center Locked)
    local center = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    fovCircle.Position = center; fovCircle.Visible = fovOn
    if aim then
        local target, dist = nil, fovCircle.Radius
        for _, v in pairs(game.Players:GetPlayers()) do
            if v ~= lplr and v.Character and v.Character:FindFirstChild("Head") and v.Character.Humanoid.Health > 0 then
                local p, on = camera:WorldToViewportPoint(v.Character.Head.Position)
                if on then
                    local mag = (Vector2.new(p.X, p.Y) - center).Magnitude
                    if mag < dist then dist = mag; target = v end
                end
            end
        end
        if target then camera.CFrame = camera.CFrame:Lerp(CFrame.new(camera.CFrame.Position, target.Character.Head.Position), 0.15) end
    end
end)

-- ESP / INFO / LINE
local function createESP(p)
    local box = Drawing.new("Square"); box.Thickness = 1; box.Filled = false
    local info = Drawing.new("Text"); info.Size = 14; info.Center = true; info.Outline = true
    local line = Drawing.new("Line"); line.Thickness = 1
    
    RunService.RenderStepped:Connect(function()
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p ~= lplr and p.Character.Humanoid.Health > 0 then
            local pos, on = camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
            if on then
                if esp then
                    local hPos = camera:WorldToViewportPoint(p.Character.Head.Position)
                    local lPos = camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position - Vector3.new(0,3,0))
                    box.Size = Vector2.new(2000/pos.Z, hPos.Y - lPos.Y)
                    box.Position = Vector2.new(pos.X - box.Size.X/2, pos.Y - box.Size.Y/2)
                    box.Color = rgb; box.Visible = true
                else box.Visible = false end
                
                if espInf then
                    info.Text = p.Name.." ["..math.floor((lplr.Character.HumanoidRootPart.Position - p.Character.HumanoidRootPart.Position).Magnitude).."m]"
                    info.Position = Vector2.new(pos.X, pos.Y - (box.Size.Y/2) - 15)
                    info.Color = Color3.new(1,1,1); info.Visible = true
                else info.Visible = false end
                
                if trac then
                    line.From = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
                    line.To = Vector2.new(pos.X, pos.Y); line.Color = rgb; line.Visible = true
                else line.Visible = false end
            else box.Visible = false; info.Visible = false; line.Visible = false end
        else box.Visible = false; info.Visible = false; line.Visible = false end
    end)
end

for _,p in pairs(game.Players:GetPlayers()) do createESP(p) end
game.Players.PlayerAdded:Connect(createESP)

-- Drag Menu
local d, ds, sp
Main.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then d = true; ds = i.Position; sp = Main.Position end end)
UserInputService.InputChanged:Connect(function(i) if d and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then local del = i.Position - ds; Main.Position = UDim2.new(sp.X.Scale, sp.X.Offset + del.X, sp.Y.Scale, sp.Y.Offset + del.Y) end end)
UserInputService.InputEnded:Connect(function() d = false end)
